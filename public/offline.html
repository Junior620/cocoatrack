<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#d97706">
  <title>Hors ligne - CocoaTrack</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      color: #78350f;
    }
    
    .container {
      max-width: 400px;
      width: 100%;
      text-align: center;
    }
    
    .icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 1.5rem;
      background: #d97706;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .icon svg {
      width: 40px;
      height: 40px;
      fill: white;
    }
    
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #92400e;
    }
    
    .subtitle {
      font-size: 1rem;
      color: #a16207;
      margin-bottom: 2rem;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
    }
    
    .card h2 {
      font-size: 0.875rem;
      font-weight: 600;
      color: #78350f;
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .pending-ops {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: #fef3c7;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    
    .pending-ops .count {
      font-size: 1.5rem;
      font-weight: 700;
      color: #d97706;
    }
    
    .pending-ops .label {
      font-size: 0.875rem;
      color: #92400e;
    }
    
    .cached-pages {
      list-style: none;
    }
    
    .cached-pages li {
      margin-bottom: 0.5rem;
    }
    
    .cached-pages a {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: #f5f5f4;
      border-radius: 8px;
      color: #78350f;
      text-decoration: none;
      font-size: 0.875rem;
      transition: background 0.2s;
    }
    
    .cached-pages a:hover {
      background: #e7e5e4;
    }
    
    .cached-pages a svg {
      width: 20px;
      height: 20px;
      fill: #d97706;
    }
    
    .sync-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      padding: 1rem 1.5rem;
      background: #d97706;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .sync-button:hover {
      background: #b45309;
    }
    
    .sync-button:disabled {
      background: #a8a29e;
      cursor: not-allowed;
    }
    
    .sync-button svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }
    
    .sync-button.syncing svg {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .status-message {
      margin-top: 1rem;
      font-size: 0.875rem;
      color: #78350f;
    }
    
    .footer {
      margin-top: 2rem;
      font-size: 0.75rem;
      color: #a16207;
    }
    
    /* No sensitive data warning */
    .security-note {
      font-size: 0.75rem;
      color: #92400e;
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="icon">
      <!-- Offline cloud icon -->
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM19 18H6c-2.21 0-4-1.79-4-4s1.79-4 4-4h.71C7.37 7.69 9.48 6 12 6c3.04 0 5.5 2.46 5.5 5.5v.5H19c1.66 0 3 1.34 3 3s-1.34 3-3 3z"/>
        <path d="M12 10l-4 4h3v4h2v-4h3z" transform="rotate(180 12 14)"/>
      </svg>
    </div>
    
    <h1>Vous êtes hors ligne</h1>
    <p class="subtitle">Pas de connexion Internet détectée</p>
    
    <div class="card">
      <h2>Opérations en attente</h2>
      <div class="pending-ops">
        <span class="count" id="pendingCount">-</span>
        <span class="label">opérations à synchroniser</span>
      </div>
      <button class="sync-button" id="syncButton" onclick="triggerSync()">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
        </svg>
        <span>Synchroniser maintenant</span>
      </button>
      <p class="status-message" id="statusMessage"></p>
    </div>
    
    <div class="card">
      <h2>Pages disponibles hors ligne</h2>
      <ul class="cached-pages" id="cachedPages">
        <li>
          <a href="/">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
            Accueil
          </a>
        </li>
        <li>
          <a href="/dashboard">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
            </svg>
            Tableau de bord
          </a>
        </li>
        <li>
          <a href="/planteurs">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
            </svg>
            Planteurs
          </a>
        </li>
        <li>
          <a href="/sync">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
            </svg>
            Synchronisation
          </a>
        </li>
      </ul>
      <p class="security-note">
        ⚠️ Pour votre sécurité, la connexion n'est pas disponible hors ligne.
      </p>
    </div>
    
    <p class="footer">
      CocoaTrack V2 • Mode hors ligne
    </p>
  </div>

  <script>
    // Get pending operations count from IndexedDB
    async function getPendingOpsCount() {
      try {
        const request = indexedDB.open('cocoatrack-offline', 2);
        
        return new Promise((resolve, reject) => {
          request.onerror = () => resolve(0);
          
          request.onsuccess = (event) => {
            const db = event.target.result;
            
            if (!db.objectStoreNames.contains('ops_queue')) {
              resolve(0);
              return;
            }
            
            const transaction = db.transaction(['ops_queue'], 'readonly');
            const store = transaction.objectStore('ops_queue');
            const index = store.index('by-status');
            const countRequest = index.count('pending');
            
            countRequest.onsuccess = () => {
              resolve(countRequest.result);
            };
            
            countRequest.onerror = () => {
              resolve(0);
            };
          };
        });
      } catch (error) {
        console.error('Error getting pending ops count:', error);
        return 0;
      }
    }
    
    // Update pending count display
    async function updatePendingCount() {
      const count = await getPendingOpsCount();
      document.getElementById('pendingCount').textContent = count;
      
      const syncButton = document.getElementById('syncButton');
      if (count === 0) {
        syncButton.disabled = true;
        document.getElementById('statusMessage').textContent = 'Aucune opération en attente';
      } else {
        syncButton.disabled = !navigator.onLine;
        if (!navigator.onLine) {
          document.getElementById('statusMessage').textContent = 'Connexion requise pour synchroniser';
        }
      }
    }
    
    // Trigger sync
    async function triggerSync() {
      const syncButton = document.getElementById('syncButton');
      const statusMessage = document.getElementById('statusMessage');
      
      if (!navigator.onLine) {
        statusMessage.textContent = 'Pas de connexion Internet';
        return;
      }
      
      syncButton.classList.add('syncing');
      syncButton.disabled = true;
      statusMessage.textContent = 'Synchronisation en cours...';
      
      try {
        // Try to register background sync
        if ('serviceWorker' in navigator && 'sync' in window.SyncManager) {
          const registration = await navigator.serviceWorker.ready;
          await registration.sync.register('sync-operations');
          statusMessage.textContent = 'Synchronisation démarrée';
        } else {
          // Fallback: redirect to sync page
          window.location.href = '/sync';
        }
      } catch (error) {
        console.error('Sync error:', error);
        statusMessage.textContent = 'Erreur de synchronisation';
      } finally {
        syncButton.classList.remove('syncing');
        syncButton.disabled = false;
        
        // Refresh count after a delay
        setTimeout(updatePendingCount, 2000);
      }
    }
    
    // Listen for online/offline events
    window.addEventListener('online', () => {
      document.getElementById('statusMessage').textContent = 'Connexion rétablie !';
      updatePendingCount();
      
      // Auto-redirect to home after a short delay
      setTimeout(() => {
        window.location.href = '/';
      }, 1500);
    });
    
    window.addEventListener('offline', () => {
      document.getElementById('statusMessage').textContent = 'Connexion perdue';
      updatePendingCount();
    });
    
    // Initialize
    updatePendingCount();
  </script>
</body>
</html>
